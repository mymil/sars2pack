all_nyt_states = function() c("Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", 
"Connecticut", "Delaware", "District of Columbia", "Florida", 
"Georgia", "Guam", "Hawaii", "Idaho", "Illinois", "Indiana", 
"Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", 
"Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", 
"Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", 
"New Mexico", "New York", "North Carolina", "North Dakota", "Northern Mariana Islands", 
"Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Puerto Rico", 
"Rhode Island", "South Carolina", "South Dakota", "Tennessee", 
"Texas", "Utah", "Vermont", "Virgin Islands", "Virginia", "Washington", 
"West Virginia", "Wisconsin", "Wyoming")

all_ejhu_alpha3 = function() c("AFG", "ALB", "DZA", "AND", "AGO", "ATG", "ARG", "ARM", "AUS", 
"AUT", "AZE", "BHS", "BHR", "BGD", "BRB", "BLR", "BEL", "BEN", 
"BTN", "BOL", "BIH", "BRA", "BRN", "BGR", "BFA", "CPV", "KHM", 
"CMR", "CAN", "CAF", "TCD", "CHL", "CHN", "COL", "COG", "COD", 
"CRI", "CIV", "HRV", "CUB", "CYP", "CZE", "DNK", "DJI", "DOM", 
"ECU", "EGY", "SLV", "GNQ", "ERI", "EST", "SWZ", "ETH", "FJI", 
"FIN", "FRA", "GAB", "GMB", "GEO", "DEU", "GHA", "GRC", "GTM", 
"GIN", "GUY", "HTI", "VAT", "HND", "HUN", "ISL", "IND", "IDN", 
"IRN", "IRQ", "IRL", "ISR", "ITA", "JAM", "JPN", "JOR", "KAZ", 
"KEN", "KOR", "KWT", "KGZ", "LVA", "LBN", "LBR", "LIE", "LTU", 
"LUX", "MDG", "MYS", "MDV", "MLT", "MRT", "MUS", "MEX", "MDA", 
"MCO", "MNG", "MNE", "MAR", "NAM", "NPL", "NLD", "NZL", "NIC", 
"NER", "NGA", "MKD", "NOR", "OMN", "PAK", "PAN", "PNG", "PRY", 
"PER", "PHL", "POL", "PRT", "QAT", "ROU", "RUS", "RWA", "LCA", 
"VCT", "SMR", "SAU", "SEN", "SRB", "SYC", "SGP", "SVK", "SVN", 
"SOM", "ZAF", "ESP", "LKA", "SDN", "SUR", "SWE", "CHE", "TWN", 
"TZA", "THA", "TGO", "TTO", "TUN", "TUR", "UGA", "UKR", "ARE", 
"GBR", "URY", "USA", "UZB", "VEN", "VNM", "ZMB", "ZWE", "DMA", 
"GRD", "MOZ", "SYR", "TLS", "BLZ", "LAO", "LBY", "PSE", "GNB", 
"MLI", "KNA", "XKX", "MMR", "BWA", "BDI", "SLE", "MWI", "SSD", 
"ESH", "STP", "YEM")

all_ejhu_alpha2 = function() c("AF", "AL", "DZ", "AD", "AO", "AG", "AR", "AM", "AU", "AT", 
"AZ", "BS", "BH", "BD", "BB", "BY", "BE", "BJ", "BT", "BO", "BA", 
"BR", "BN", "BG", "BF", "CV", "KH", "CM", "CA", "CF", "TD", "CL", 
"CN", "CO", "CG", "CD", "CR", "CI", "HR", "CU", "CY", "CZ", "DK", 
"DJ", "DO", "EC", "EG", "SV", "GQ", "ER", "EE", "SZ", "ET", "FJ", 
"FI", "FR", "GA", "GM", "GE", "DE", "GH", "GR", "GT", "GN", "GY", 
"HT", "VA", "HN", "HU", "IS", "IN", "ID", "IR", "IQ", "IE", "IL", 
"IT", "JM", "JP", "JO", "KZ", "KE", "KR", "KW", "KG", "LV", "LB", 
"LR", "LI", "LT", "LU", "MG", "MY", "MV", "MT", "MR", "MU", "MX", 
"MD", "MC", "MN", "ME", "MA", "NA", "NP", "NL", "NZ", "NI", "NE", 
"NG", "MK", "NO", "OM", "PK", "PA", "PG", "PY", "PE", "PH", "PL", 
"PT", "QA", "RO", "RU", "RW", "LC", "VC", "SM", "SA", "SN", "RS", 
"SC", "SG", "SK", "SI", "SO", "ZA", "ES", "LK", "SD", "SR", "SE", 
"CH", "TW", "TZ", "TH", "TG", "TT", "TN", "TR", "UG", "UA", "AE", 
"GB", "UY", "US", "UZ", "VE", "VN", "ZM", "ZW", "DM", "GD", "MZ", 
"SY", "TL", "BZ", "LA", "LY", "PS", "GW", "ML", "KN", "MM", "BW", 
"BI", "SL", "MW", "SS", "EH", "ST", "YE")

all_ejhu_names = function() c("Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", 
"Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", 
"Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", 
"Belize", "Benin", "Bhutan", "Bolivia (Plurinational State of)", 
"Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei Darussalam", 
"Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", 
"Cameroon", "Canada", "Central African Republic", "Chad", "Chile", 
"China", "Colombia", "Congo", "Congo (Democratic Republic of the)", 
"Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", 
"Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", 
"Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", 
"Estonia", "Ethiopia", "Fiji", "Finland", "France", "Gabon", 
"Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", 
"Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Holy See", 
"Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran (Islamic Republic of)", 
"Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", 
"Kazakhstan", "Kenya", "Korea (Republic of)", "Kuwait", "Kyrgyzstan", 
"Lao People's Democratic Republic", "Latvia", "Lebanon", "Liberia", 
"Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Macedonia (the former Yugoslav Republic of)", 
"Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", 
"Mauritania", "Mauritius", "Mexico", "Moldova (Republic of)", 
"Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", 
"Myanmar", "Namibia", "Nepal", "Netherlands", "New Zealand", 
"Nicaragua", "Niger", "Nigeria", "Norway", "Oman", "Pakistan", 
"Palestine, State of", "Panama", "Papua New Guinea", "Paraguay", 
"Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", 
"Russian Federation", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", 
"Saint Vincent and the Grenadines", "San Marino", "Sao Tome and Principe", 
"Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", 
"Singapore", "Slovakia", "Slovenia", "Somalia", "South Africa", 
"South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Swaziland", 
"Sweden", "Switzerland", "Syrian Arab Republic", "Taiwan", "Tanzania, United Republic of", 
"Thailand", "Timor-Leste", "Togo", "Trinidad and Tobago", "Tunisia", 
"Turkey", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom of Great Britain and Northern Ireland", 
"United States of America", "Uruguay", "Uzbekistan", "Venezuela (Bolivarian Republic of)", 
"Viet Nam", "Western Sahara", "Yemen", "Zambia", "Zimbabwe", extra_ejhu())


extra_ejhu = function() c("Diamond Princess", "Kosovo", "MS Zaandam")


get_EpiEstim_SI_model = function( cens = TRUE, distr = "G" ) {
  stopifnot (distr %in% c("G", "W", "L"))
  get(paste0("si_", ifelse(cens, "cens", "pos"), "_", distr))
}

allopts = function() sort(c( all_nyt_states(), all_ejhu_alpha3(),
   all_ejhu_alpha2(), all_ejhu_names()))

#library(shinyalert)
chksel = function(nyd, ej) {
 ui = fluidPage(
  useToastr(),
  sidebarLayout(
   sidebarPanel(
    selectInput("region", "Region", choices=allopts(), selected="France"),
   dateInput("inidat", "Start of outbreak", value="2020-03-15", min="2020-01-01",
       max="2020-04-01"),
    radioButtons("sitype", "Serial Interval Method",
      choices=c("2009 flu", "uncertain"), selected="2009 flu"),
    conditionalPanel(
     condition = "input.sitype == 'uncertain'",
       numericInput("parmn", "mean SI", min=1, max=6, step=.1,
                      value=4),
       numericInput("parmnsd", "SD SI", min=.5, max=12, step=.1,
                      value=5)
     ),  
    numericInput("winsz", "window size", min=1, max=14, step=1,
                   value=7),
   width=3),
   mainPanel(
    verbatimTextOutput("sel"),
    plotOutput("sel2")
   )
  )
 )
 server = function(input, output) {
  findSelRegion = reactive({
   sel = input$region
   if (sel %in% all_nyt_states()) return("state")
   else if (sel %in% all_ejhu_alpha3()) return("alp3")
   else if (sel %in% all_ejhu_alpha2()) return("alp2")
   else if (sel %in% all_ejhu_names()) return("name")
   else if (sel %in% extra_ejhu()) return("ext")
   })
  output$sel = renderPrint( {
   paste0( findSelRegion(), ":", input$region )
   } )
  output$sel2 = renderPlot( {
    validate(need(nchar(input$inidat)>0, "abc"))
    data("Flu2009", package="EpiEstim")
    zz = obtain_incidence( findSelRegion(), input$region, nyd, ej, input$inidat ) 
    ee = EpiEstim::estimate_R( zz,
       method="non_parametric_si",
        config = EpiEstim::make_config(list(si_distr = Flu2009$si_distr)))
    plot(ee)
   }, height=750 )
 }
 runApp(list(ui=ui, server=server))
}

trimlz = function(x) x[-seq_len(which.max(x>0)-1)]  # trims leading zeroes
indlz = function(x) seq_len(which.max(x>0)-1)  # indices of leading zeroes

obtain_incidence = function( type, selection, nytd, ejhu, initdat ) {
#
# drops leading zeroes
#
 if (type == "state") ans = (nytd[nytd$state == selection & nytd$subset == "confirmed",])
 else if (type == "alp3") ans = (ejhu[!is.na(ejhu$alpha3Code) & 
               ejhu$alpha3Code == selection & ejhu$subset == "confirmed",])
 else if (type == "alp2") ans = (ejhu[ !is.na(ejhu$alpha2Code) &
               ejhu$alpha2Code == selection & ejhu$subset == "confirmed",])
 else if (type == "name") 
           ans = ( ejhu[ !is.na(ejhu$name) & ejhu$name == selection & ejhu$subset == "confirmed" ,])
 else if (type == "ext") ans = ( ejhu[ !is.na(ejhu$CountryRegion) &
               ejhu$CountryRegion == selection & ejhu$subset == "confirmed",])
 if ("ProvinceState" %in% names(ans)) {
   chktab = length(unique(ans$ProvinceState))
   if (chktab>1) ans = ans[is.na(ans$ProvinceState), ]
   }
 drp = indlz(ans$count)
 if (length(drp)>0) 
   ans = (ans %>% dplyr::filter((1:nrow(ans))>max(drp)))
 ans = dplyr::filter(ans, ans$date > initdat)
 chk = data.frame(I=diff(c(0,ans$count)), dates=ans$date)  # for EpiEstim::estimate_R
 if (any(chk$I<0)) {
   print(any(chk$I<0))
   bad = which(chk$I < 0)
   chk$I[bad] = 0
   toastr_warning("negative incidence values set to zero")
   }
 chk
}
  
